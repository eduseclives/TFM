name: "CI/CD con Seguridad SAST y DefectDojo"

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-scan:
    name: Compilación, Escaneo y DefectDojo
    # Cambiado a self-hosted para alcanzar el localhost del DefectDojo
    runs-on: self-hosted
    
    strategy:
      matrix:
        service: [user-service, auth-service, gateway-service, registry-service, product-service, order-service]
      fail-fast: false

    steps:
    - name: Checkout del código
      uses: actions/checkout@v4

    - name: Configurar JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Compilar con Gradle
      shell: pwsh
      run: |
        cd ${{ matrix.service }}
        ./gradlew build -x test

    - name: OWASP Dependency Check
      uses: dependency-check/DependencyCheck-Action@main
      with:
        project: ${{ matrix.service }}
        path: './${{ matrix.service }}'
        format: 'XML' # XML es mejor para importar en DefectDojo
        out: 'reports/${{ matrix.service }}'
        args: >
          --failOnCVSS 7
      continue-on-error: true

    - name: Subir a DefectDojo (Dependency Check)
      shell: pwsh
      env:
        DOJO_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
        DOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
      run: |
        # Nota: Ajusta el product_id según corresponda en tu DefectDojo
        $reportPath = "reports/${{ matrix.service }}/dependency-check-report.xml"
        if (Test-Path $reportPath) {
          curl.exe -X POST "$($env:DOJO_URL)/api/v2/import-scan/" `
          -H "Authorization: Token $($env:DOJO_TOKEN)" `
          -F "active=true" `
          -F "verified=true" `
          -F "scan_type=Dependency Check Scan" `
          -F "product_name=${{ matrix.service }}" `
          -F "engagement_name=CI/CD Scan $(Get-Date -Format 'yyyy-MM-dd')" `
          -F "file=@$reportPath"
        } else {
          Write-Host "No se encontró el reporte en $reportPath"
        }

  # CodeQL requiere configuración específica en self-hosted Windows
  # Se recomienda activarlo una vez el runner esté validado
  analyze:
    name: Análisis SAST (CodeQL)
    runs-on: self-hosted
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
    - name: Checkout del código
      uses: actions/checkout@v4
    - name: Inicializar CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: 'java-kotlin'
    - name: Autobuild
      uses: github/codeql-action/autobuild@v3
    - name: Realizar Análisis de CodeQL
      uses: github/codeql-action/analyze@v3
