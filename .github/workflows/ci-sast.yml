name: "CI/CD con Seguridad SAST y DefectDojo"

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-scan:
    name: Compilación, Escaneo y DefectDojo
    # se usa self-hosted para alcanzar el localhost del DefectDojo
    runs-on: self-hosted
    timeout-minutes: 60
    
    strategy:
      matrix:
        service: [user-service, auth-service, gateway-service, registry-service, product-service, order-service]
      fail-fast: false

    steps:
    - name: Checkout del código
      uses: actions/checkout@v4

    - name: Configurar JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Compilar con Gradle
      #shell: pwsh
      run: |
        cd ${{ matrix.service }}
        chmod +x gradlew
        ./gradlew build -x test

    - name: OWASP Dependency Check
      uses: dependency-check/DependencyCheck-Action@main
      with:
        project: ${{ matrix.service }}
        path: './${{ matrix.service }}'
        format: 'XML' # XML es mejor para importar en DefectDojo
        out: 'reports/${{ matrix.service }}'
        args: >
          --failOnCVSS 7
      continue-on-error: true

    - name: Subir a DefectDojo (Dependency Check)
      #shell: pwsh
      env:
        DOJO_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
        DOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
      run: |
        REPORT_PATH="reports/${{ matrix.service }}/dependency-check-report.xml"
        if [ -f "$REPORT_PATH" ]; then
          curl -X POST "${DOJO_URL}/api/v2/import-scan/" \
          -H "Authorization: Token ${DOJO_TOKEN}" \
          -F "active=true" \
          -F "verified=true" \
          -F "scan_type=Dependency Check Scan" \
          -F "product_name=${{ matrix.service }}" \
          -F "engagement_name=CI/CD Scan $(date +'%Y-%m-%d')" \
          -F "file=@$REPORT_PATH"
        else
          echo "No se encontró el reporte en $REPORT_PATH"
        fi

  analyze:
    name: Análisis SAST (CodeQL)
    runs-on: self-hosted
    timeout-minutes: 60
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
    - name: Checkout del código
      uses: actions/checkout@v4
    - name: Configurar JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'  
    - name: Inicializar CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: 'java-kotlin'
    # las siguientes 2 lineas se usan para cuando se tienen repos por separado
    #- name: Autobuild
    #  uses: github/codeql-action/autobuild@v3
    # las siguientes lineas se usan para cuando se tiene un solo repo
    - name: Compilación Manual para CodeQL
      run: |
        # Lista de tus servicios
        services=("user-service" "auth-service" "gateway-service" "registry-service" "product-service" "order-service")
        
        for service in "${services[@]}"; do
          echo "Compilando $service para análisis..."
          if [ -f "$service/gradlew" ]; then
            cd $service
            chmod +x gradlew
            ./gradlew build -x test
            cd ..
          else
            echo "No se encontró gradlew en el servicio $service"
          fi
        done
    - name: Realizar Análisis de CodeQL
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:java-kotlin"

    - name: Subir a DefectDojo (CodeQL SARIF)
      if: always()
      env:
        DOJO_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
        DOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
      run: |
        # Buscar el archivo SARIF generado por CodeQL en el directorio temporal del runner
        SARIF_FILE=$(find "${{ runner.temp }}" -name "*.sarif" | head -n 1)
        if [ -n "$SARIF_FILE" ]; then
          echo "Subiendo $SARIF_FILE a DefectDojo..."
          curl -X POST "${DOJO_URL}/api/v2/import-scan/" \
          -H "Authorization: Token ${DOJO_TOKEN}" \
          -F "active=true" \
          -F "verified=true" \
          -F "scan_type=SARIF" \
          -F "product_name=Monorepo-SAST" \
          -F "engagement_name=CodeQL Scan $(date +'%Y-%m-%d')" \
          -F "file=@$SARIF_FILE"
        else
          echo "No se encontró ningún archivo SARIF para subir."
        fi
